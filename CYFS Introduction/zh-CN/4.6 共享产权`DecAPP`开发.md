# 维护组织信息

## 成立一个组织

在`CYFS`系统中成立一个组织，就是构造一个`Group`对象，并将其发布到`MetaChain`，在方法上跟其他对象的构造和上链并无不同。但`Group`对象上链有几点要求：

1. 必须有所有成员的全签名（`Desc`和`Body`）；
2. 发起人可以是空，否则必须是管理员之一；
3. 上一个`Group`版本的`ObjectShellId`必须是空；

除了在程序里采用和其他对象相同的方法进行`构造`、`签名`、`上链`以外，还在命令行工具`desc-tool`中添加了支持。

-   构造`Group`对象

    具体用法直接输入`desc-tool create group -h`查看帮助信息如下：

    ```
    >desc-tool create group -h

    USAGE:
        desc-tool.exe create group [FLAGS] [OPTIONS] --admins <admins> --area <area>

    FLAGS:
        -h, --help       Prints help information
        -O, --org        create a group as organization that administrators is changable.
        -V, --version    Prints version information

    OPTIONS:
        -A, --admins <admins>              admins in group. format [PeopleId:title]
        -a, --area <area>                  Object area info. format [county:carrier:city:inner]
        -d, --description <description>    description of group
        -F, --founder <founder>            founder of group
        -I, --icon <icon>                  icon of group
            --idfile <id_file>             write object id to file
        -M, --members <members>            members in group. format [PeopleId:title]
        -n, --name <name>                  name of group
        -l, --oodlist <ood_list>           oods in group
            --savepath <save_path>         save file path
    ```

    如，我们想要构造一个包含 4 名管理员, 2 个普通成员，和 4 个 OOD 的`Group`所有人都没有`title`，可以使用如下命令：

    ```
    .\desc-tool.exe create group -F=5r4MYfFfTakY1h6vdEuMurpkawk4MZpB5RmY9CFqSj99 -A=5r4MYfFfTakY1h6vdEuMurpkawk4MZpB5RmY9CFqSj99:;5r4MYfFPPRDNNcJdvve4XVx3FE355PUDpqaA5Mm9UcFh:;5r4MYfFAiXjbEkHZvc1NtHgJkZ4A7LJQcrY7cJeMz5YB:;5r4MYfFKmpMT2u2P13p3bLC6KtGEVsp42X85h5e2onhZ:; -M=5r4MYfF5r9cUfL9JemVXwLWJjufXETYSjfXqEsR3Qwn5:;5r4MYfF8ZaksbXfnZbdjiYJuJv8U4FfvyBgdHq7RiPhY:; -l=5aSixgN8tVt1SAM4xBfc1dYvdrU7d5fVeZrzNFpx8FiB;5aSixgMxgNuMQFcG41fW1CN7MTsKMqEuVjW16BnJWrGW;5aSixgN64mtdhmNvKZ681P3iPZbnQPyQsezTFNB2HSdx;5aSixgNS8ij1mkjjNe2UWHVgVYFhr4dJF5BuxxpTb1m8; -n="group" -I="icon" -d="description" -a=0:0:0:0 -O --savepath="./" --idfile="./group.id.txt"
    ```

    上述命令执行完成后，将在当前工作目录（由`savepath`参数指定）出现一个以新构造`GroupId`命名的`.desc`文件，其即为新构造`Group`的编码数据。

-   把构造好的`Group`编码数据顺次分发给每个成员，要求他们签名确认：

```
.\desc-tool sign ${desc-path} -s=${signer-secret-path} -t=${signer-desc-path} -dba
```

-   发布到`MetaChain`

```
>cyfs-meta-client.exe putdesc -h
create or update desc on meta,exclude userdata

USAGE:
    cyfs-meta-client.exe putdesc [FLAGS] [OPTIONS] --caller <caller> [ARGS]

FLAGS:
    -h, --help       Prints help information
    -u               force update body time on put
    -V, --version    Prints version information

OPTIONS:
    -c, --caller <caller>              desc and sec file path, exclude extension [default: C:\Users\Bucky\.cyfs\owner]
    -d, --desc <desc>                  desc file send to meta, default caller`s desc
    -m, --meta_target <meta_target>    meta client target [default: dev]
    -v, --value <value>                balance from caller to desc account when create [default: 0]

ARGS:
    <price>      desc rent
    <coin_id>    coin id
```

## 更新组织信息

更新组织的方法也和其他可变对象一样，更新`Body`信息，然后发布到`MetaChain`，但更新`Group`有以下几点要求：

1. 所有新加入成员都应该对新`Group`签名；
2. 新`Group`必须持有链上当前最新版`Group`中半数以上管理员全签名；
3. 新`Group`应该明确标注其从当前`MetaChain`上最新版本升级而已，即其`prev_shell_id`字段指向当前最新`Group`的`ObjectShellId`；
4. 新`Group`的版本号必须在当前链上最新`Group`的版本号基础上增加 1。

同样，我们可以使用`desc-tool`工具来完成更新操作：

```
>desc-tool modify -h

modify desc

USAGE:
    desc-tool modify [FLAGS] [OPTIONS] <desc>

FLAGS:
        --appstart    start app, default false
    -h, --help        Prints help information

OPTIONS:
        --add_admin <add_admins>        append administrators to group. format [PeopleId:title]
        --add_member <add_members>      append members to group. format [PeopleId:title]
    -o, --add_ood <add_oods>            device id append to people or group
    -A, --admins <admins>               set administrators to group. format [PeopleId:title]
        --appid <app_id>                app id add to app list
        --appver <app_ver>              app ver add to app list
    -d, --description <description>     description of group
    -e, --eps <eps>                     new endpoint list
    -I, --icon <icon>                   icon of people or group
    -m, --members <members>             set members to group. format [PeopleId:title]
    -n, --name <name>                   name of people or group
    -l, --ood_lists <ood_lists>         device id set to people or group
        --prev_shell <prev_shell_id>    prev-shell-id of group
        --rm_admin <remove_admins>      remove administrators from group. format [PeopleId]
        --rm_member <remove_members>    remove members from group. format [PeopleId]
    -s, --sn <sn>                       new sn list
        --source <source>               add source to app, {ver}:{id}
    -v, --version <version>             version of group

ARGS:
    <desc>    desc file to modify
```

举例如下：

```
.\desc-tool modify 67fz8e9wt6Yqb9ex61tr2C1PwCqavBLFe153wfiVAhqQ.desc --add_admin=5r4MYfFBsQqy4r2LTccK1yyipRTtAjqvhX3GLU2qX3Lo --add_member=5r4MYfFapPzrXhfxWJNZJf4pk5Ncfrx5ax2yumWKZrZj
.\desc-tool modify 67fz8e9wt6Yqb9ex61tr2C1PwCqavBLFe153wfiVAhqQ.desc --add_ood=5aSixgNLsF6r3qjDKP3XkBwnDRSr5G5hrGRM2v2LnLoA
.\desc-tool modify 67fz8e9wt6Yqb9ex61tr2C1PwCqavBLFe153wfiVAhqQ.desc --prev_shell=9cfBkPt2RPa3MofMmsAXpq8xHYn8A2xvVPuQiBT4XTp9 -v=2
```

收集签名和上链过程和新建`Group`相同，不再赘述。

## 在`NON`中保存不同版本的`Group`对象

上述更新过程中，`Group`对象都是存储在文件系统中。而在`DecApp`中，`Group`的更新过程应该是自动化的，所以各成员的`NON`系统中必不可少地要存储不同版本的`Group`对象，起码有存储两个`Group`版本的需求：

1. 当前最新版本`Group`，跟链上最新版一样；
2. 更新中的`Group`，正在收集各成员签名，还没上链最终发布。

在`CYFS`的`NON`中提供了`ObjectShell`核心对象，对不同版本对象加个壳，不同版本的壳对象都是一个全新对象，它们的`ObjectId`不同，可以共存于`NON`系统。

关于`ObjectShell`的陈述，参阅[issue 219](https://github.com/buckyos/CYFS/issues/219)

# 维护组织数据
